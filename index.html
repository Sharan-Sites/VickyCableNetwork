<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .expiring-today { background-color: #fff3cd; }
    .expired { background-color: #f8d7da; }
    .active { background-color: #d1e7dd; }
    .card { margin-bottom: 20px; }
  </style>
</head>

  <script>
// Fetch data from Google Apps Script
async function loadData() {
  try {
    const response = await fetch('https://script.google.com/macros/s/AKfycbxVyXvu8k32d1STseHOGRXDXr4NIBM0XaU_WFif58nkEpm-XfPaWoDT0fAyqpyVdZtG8Q/exec');
    const data = await response.json();
    // Use data to populate your GitHub Pages site
  } catch (error) {
    console.error('Error loading data:', error);
  }
}
loadData();
</script> 
<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>ðŸ“º TV Subscription Dashboard</h1>
      <button id="refreshBtn" class="btn btn-primary">Refresh Data</button>
    </div>

    <div class="row">
      <!-- Stats Cards -->
      <div class="col-md-3">
        <div class="card text-white bg-primary">
          <div class="card-body">
            <h5 class="card-title">Total Customers</h5>
            <p id="totalCustomers" class="card-text display-4">0</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-white bg-warning">
          <div class="card-body">
            <h5 class="card-title">Expiring Today</h5>
            <p id="expiringToday" class="card-text display-4">0</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-white bg-danger">
          <div class="card-body">
            <h5 class="card-title">Expired</h5>
            <p id="expiredCount" class="card-text display-4">0</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-white bg-success">
          <div class="card-body">
            <h5 class="card-title">Active</h5>
            <p id="activeCount" class="card-text display-4">0</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Row -->
    <div class="row mt-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Plan Distribution</h5>
            <canvas id="planChart" height="250"></canvas>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Revenue Projection</h5>
            <canvas id="revenueChart" height="250"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Customer Table -->
    <div class="card mt-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Customer Subscriptions</h5>
        <div>
          <button id="showExpiring" class="btn btn-sm btn-warning me-2">Expiring Today</button>
          <button id="showExpired" class="btn btn-sm btn-danger me-2">Expired</button>
          <button id="showAll" class="btn btn-sm btn-success">Show All</button>
        </div>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table id="customerTable" class="table table-striped">
            <thead>
              <tr>
                <th>Setup Box</th>
                <th>Customer</th>
                <th>Phone</th>
                <th>Plan</th>
                <th>Amount</th>
                <th>Last Payment</th>
                <th>Expiry Date</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="customerData">
              <!-- Data will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', loadDashboardData);
    document.getElementById('refreshBtn').addEventListener('click', loadDashboardData);
    document.getElementById('showExpiring').addEventListener('click', () => filterCustomers('expiring'));
    document.getElementById('showExpired').addEventListener('click', () => filterCustomers('expired'));
    document.getElementById('showAll').addEventListener('click', () => filterCustomers('all'));

    function loadDashboardData() {
      google.script.run.withSuccessHandler(updateDashboard).getDashboardData();
    }

    function updateDashboard(data) {
      // Update stats
      document.getElementById('totalCustomers').textContent = data.stats.total;
      document.getElementById('expiringToday').textContent = data.stats.expiringToday;
      document.getElementById('expiredCount').textContent = data.stats.expired;
      document.getElementById('activeCount').textContent = data.stats.active;
      
      // Render charts
      renderPlanChart(data.charts.planDistribution);
      renderRevenueChart(data.charts.revenueProjection);
      
      // Render customer table
      renderCustomerTable(data.customers);
    }

    function renderCustomerTable(customers) {
      // Store for filtering
      window.allCustomers = customers;
      
      const tbody = document.getElementById('customerData');
      tbody.innerHTML = '';
      
      customers.forEach(customer => {
        const row = document.createElement('tr');
        const statusClass = getStatusClass(customer.expiryDate);
        const daysLeft = getDaysLeft(customer.expiryDate);
        
        row.innerHTML = `
          <td>${customer.setupBox}</td>
          <td>${customer.name}</td>
          <td>${customer.phone}</td>
          <td>${customer.plan}</td>
          <td>â‚¹${customer.amount}</td>
          <td>${formatDate(customer.lastPayment)}</td>
          <td>${formatDate(customer.expiryDate)}</td>
          <td><span class="badge ${statusClass}">${getStatusText(daysLeft)}</span></td>
          <td>
            <button class="btn btn-sm btn-outline-primary send-reminder" data-phone="${customer.phone}">
              Send Reminder
            </button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
      
      // Add event listeners to reminder buttons
      document.querySelectorAll('.send-reminder').forEach(btn => {
        btn.addEventListener('click', function() {
          const phone = this.getAttribute('data-phone');
          google.script.run.sendSingleReminder(phone);
          alert('Reminder sent to ' + phone);
        });
      });
    }
    
    // Helper functions
    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-IN');
    }
    
    function getDaysLeft(expiryDate) {
      const today = new Date();
      const expiry = new Date(expiryDate);
      return Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
    }
    
    function getStatusClass(expiryDate) {
      const daysLeft = getDaysLeft(expiryDate);
      if (daysLeft < 0) return 'bg-danger';
      if (daysLeft === 0) return 'bg-warning';
      if (daysLeft <= 3) return 'bg-info';
      return 'bg-success';
    }
    
    function getStatusText(daysLeft) {
      if (daysLeft < 0) return 'EXPIRED';
      if (daysLeft === 0) return 'TODAY';
      if (daysLeft === 1) return 'TOMORROW';
      return `${daysLeft} days`;
    }
    
    function filterCustomers(filterType) {
      if (!window.allCustomers) return;
      
      const filtered = window.allCustomers.filter(customer => {
        const daysLeft = getDaysLeft(customer.expiryDate);
        
        if (filterType === 'expiring') return daysLeft <= 3;
        if (filterType === 'expired') return daysLeft < 0;
        return true;
      });
      
      renderCustomerTable(filtered);
    }
    
    function renderPlanChart(data) {
      // Chart.js implementation for plan distribution
      const ctx = document.getElementById('planChart').getContext('2d');
      if (window.planChart) window.planChart.destroy();
      
      window.planChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: data.labels,
          datasets: [{
            data: data.values,
            backgroundColor: [
              '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'
            ]
          }]
        }
      });
    }
    
    function renderRevenueChart(data) {
      // Chart.js implementation for revenue projection
      const ctx = document.getElementById('revenueChart').getContext('2d');
      if (window.revenueChart) window.revenueChart.destroy();
      
      window.revenueChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [{
            label: 'Projected Revenue',
            data: data.values,
            backgroundColor: '#36A2EB'
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }
  </script>
</body>
</html>
